-- source include/have_innodb.inc
delimiter ~~;
create or replace procedure drop_archives (in vtmd varchar(64))
begin
  declare archive_name varchar(64);
  declare cur_done bool default false;
  declare cur cursor for
    select cur_tmp.archive_name from cur_tmp;
  declare continue handler for not found set cur_done = true;

  set @tmp= concat('
    create or replace temporary table
    cur_tmp as
      select vtmd.archive_name from ', vtmd, ' as vtmd
      for system_time all
      where vtmd.archive_name is not null');
  prepare stmt from @tmp; execute stmt; drop prepare stmt;

  open cur;
  fetch_loop: loop
    fetch cur into archive_name;
    if cur_done then
      leave fetch_loop;
    end if;
    set @tmp= concat('drop table ', archive_name);
    prepare stmt from @tmp; execute stmt; drop prepare stmt;
  end loop;
end~~
delimiter ;~~

# create
set versioning_ddl_survival= off;
create or replace table t0 (x int) with system versioning;
show tables;
set versioning_ddl_survival= on;
create or replace table t0 (x int) with system versioning;
show tables;
show create table t0_vtmd;
select * from t0_vtmd for system_time all;

set versioning_ddl_survival= off;
drop table t0;
set versioning_ddl_survival= on;
--error ER_VERS_VTMD_ERROR
create or replace table t0 (x int) with system versioning;

# alter
alter table t0 add column (y int);
set @inf= 0xFFFFFFFFFFFFFFFF + 0;
select start from t0_vtmd for system_time all where end < @inf into @start;
select @start > 0 and @start < @inf;
select
  start = @start as A_start,
  (@start:= end) and end = @inf as B_end,
  name,
  substr(archive_name, 1, char_length(name)) as C_archive_name
from t0_vtmd for system_time all;

call drop_archives('t0_vtmd');
drop table t0_vtmd;
alter table t0 drop column y;
select
  start > 0 and start < @inf as A_start,
  end = @inf as B_end,
  name,
  substr(archive_name, 1, char_length(name)) as C_archive_name
from t0_vtmd for system_time all;

call drop_archives('t0_vtmd');
drop tables t0, t0_vtmd;
drop procedure drop_archives;

# rename
set versioning_ddl_survival= off;
create or replace table x0 (x int) with system versioning;
set versioning_ddl_survival= on;
rename table x0 to d0;
show tables;

drop table d0;
create or replace table x0 (x int) with system versioning;
rename table x0 to d0;
show tables;

set versioning_ddl_survival= off;
drop table d0;
set versioning_ddl_survival= on;
create or replace table x0 (x int) with system versioning;

--error ER_VERS_VTMD_ERROR
rename table x0 to d0;

drop table x0_vtmd;
rename table x0 to d0;
show tables;

drop tables d0, d0_vtmd;
